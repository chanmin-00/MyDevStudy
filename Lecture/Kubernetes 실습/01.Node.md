### 노드 관리

---

- `Cordon`
    - **특정 노드에 새로운 파드가 스케줄 되지 않도록 하는 기능**
    - **기존에 실행 중이던 파드에는 영향을 주지 않고** 새로운 파드의 배포를 막음
    
    ```bash
    # kubectl cordon {NODE_NAME}
    $ kubectl cordon secloudit-k8s-worker-1
    ```
    
    <img width="810" height="131" alt="image" src="https://github.com/user-attachments/assets/a98786ae-742d-4a70-a2b2-ab638f1007f0" />
    
    ```yaml
    apiVersion: apps/v1                     # 쿠버네티스 API 버전
    kind: Deployment                        # 리소스의 종류
    metadata:                               # 리소스의 메타데이터
      name: secloudit-deployment            # 리소스의 이름
      namespace: default                    # 리소스가 배포될 Namespace
    spec:                                   # Deployment가 관리할 파드들의 템플릿
      selector:                             # Deployment가 어떤 파드를 관리해야 하는지 레이블 지정
        matchLabels:                        # 배포할 Pod의 레이블
          apps: apps                        # 연결할 Pod의 레이블 키-값 쌍
      replicas: 1                           # 실행할 Pod의 개수
      template:                             # Deployment가 생성할 파드에 대한 템플릿
        metadata:                           # Pod에 적용할 템플릿
          labels:                           # Pod 레이블 지정
            apps: apps                      # Pod의 레이블 키-값 쌍
        spec:                               # Pod의 실제 동작 방식과 구성 설정
          containers:                       # Pod 안에 포함될 컨테이너의 상세 설정
          - name: container                 # 컨테이너 이름
            image: nginx:latest             # 컨테이너 이미지
            ports:                          # 컨테이너 포트 상세 설정
            - containerPort: 80             # 컨테이너의 포트 번호
              protocol: TCP                 # 컨테이너 프로토콜 방식 설정
    ```
    
- `Uncordon`
    - Cordon이 적용된 노드가 **다시 정상적으로 스케줄 되도록 하는 기능**
    
    ```bash
    # kubectl uncordon {NODE_NAME}
    $ kubectl uncordon secloudit-k8s-worker-1
    ```
    
    <img width="505" height="100" alt="image" src="https://github.com/user-attachments/assets/aeec1f23-1df6-4cf4-80c8-065d5313c7e6" />

    
    - secloud에서 노드 상세 조회의 테인트 목록을 보면 NoSchedule이 사라진 것을 확인할 수 있다.

- `Drain`
    - **특정 노드의 유지보수 또는 점검을 위해 실행 중인 파드들을 다른 노드로 이동시키는 기능**
    - Drain 실행 시 해당 노드는 **자동으로 Cordon 되어 새로운 파드가 스케줄 되지 않음**
    - **DaemonSet으로 배포된 파드는 모든 노드에서 실행을 보장해야 하는 파드**이므로 **Drain시 DaemonSet 파드는 삭제가 되지 않기 때문에 무시** 해야함
    
    ```bash
    # kubectl drain {NODE_NAME} -ignore-daemonsets --force
    # drain 적용
    $ kubectl drain secloudit-k8s-worker-1 -ignore-daemonsets --force
    ```
    
    - **--force 없이 실행 시:**
        
        ```java
        $ kubectl drain worker-1 --ignore-daemonsets
        
        error: cannot delete Pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet
        ```
        
        - 단독 Pod가 있으면 에러
        - `-force` 필요
    - **--ignore-daemonsets 없이 실행 시:**
        
        ```java
        $ kubectl drain worker-1 --force
        
        error: cannot delete DaemonSet-managed Pods
        ```
        
        - DaemonSet Pod 때문에 에러
        - `-ignore-daemonsets` 필요
        - DaemonSet Pod는 모든 노드에 실행되므로 제거 불가, 이 옵션으로 DaemonSet 무시하고 진행
    
    <img width="823" height="290" alt="image" src="https://github.com/user-attachments/assets/e0a97e65-3377-4832-adab-7463011c0edb" />

    
    - 1번 worker 노드의 파드가 다른 파드로 이동하게 된다.
    
    <img width="810" height="137" alt="image" src="https://github.com/user-attachments/assets/b8fdfa9a-0cf4-44fb-8000-e3c5a90cc779" />
    
    - Drain 적용 후 1번 Worker 노드에 파드가 이동하고 SchedulingDisabled가 적용된 것을 확인할 수 있다.

- `Taint`
    - **Node에 설정하여 임의의 Pod가 스케줄링 되는 것을 방지하는 기능**
    - Taint와 동일한 값의 **Toleration이 설정된 특정 Pod만 스케줄링을 허용할 수 있음**
    - Effect 필드 종류
        
        
        | NoSchedule | Taint와 동일한 값의 Toleration이 아닌 Pod는 배치되지 않음 |
        | --- | --- |
        | PreferNoSchedule | Taint와 동일한 값의 Toleration이 아닌 Pod는 배치 되지 않지만 클러스터 리소스가 부족할 경우 배치가 가능 |
        | NoExcute | 동작중인 Pod중 Taint와 동일한 값의 Toleration을 가진 Pod는 종료 |
    
    ```bash
    # Taint 적용 후 Node 상세 조회
    $ kubectl describe node secloudit-k8s-worker-1 | grep –i taint
    Taints: node-role.Kubernetes.io/control-plane:NoSchedule
    # Master 노드에는 기본 값으로 taint가 NoSchedule로 적용이 되어 있어 Master 노드에는 파드 배포가 불가능하다.
    ```
    
    - [`node-role.Kubernetes.io/control-plane`](http://node-role.Kubernetes.io/control-plane) : 파드에 설정하게 되는 노드의 키 값에 해당한다.

- `Toleration`
    - **Toleration 동일한 값의 Taint가 설정된 Node에 Pod를 배포**할 수 있도록 **Pod에 설정하는 기능**
    - Toleration이 적용 된 Pod는 Taint가 없는 Node에도 배치가 가능
    
    <img width="811" height="86" alt="image" src="https://github.com/user-attachments/assets/8a7aff61-a659-493d-a850-a171c1f46be9" />
    
    - **Taint가 적용된 Node의 key 값을 배포할 리소스의 Toleration 필드에 동일한 값으로 작성하여 배포**하면 Taint가 걸린 Node에도 Pod 배포가 가능하다.
    
    ```yaml
    apiVersion: apps/v1                     # 쿠버네티스 API 버전
    kind: Deployment                        # 리소스의 종류
    metadata:                               # 리소스의 메타데이터
      name: nginx-toleration                # 리소스의 이름
      namespace: default                    # 리소스가 배포될 Namespace
    spec:                                   # Deployment가 관리할 파드들의 템플릿
      selector:                             # Deployment가 어떤 파드를 관리해야 하는지 레이블 지정
        matchLabels:                        # 배포할 Pod의 레이블
          apps: apps                        # 연결할 Pod의 레이블 키-값 쌍
      replicas: 4                           # 실행할 Pod의 개수
      template:                             # Deployment가 생성할 파드에 대한 템플릿
        metadata:                           # Pod에 적용할 템플릿
          labels:                           # Pod 레이블 지정
            apps: apps                      # Pod의 레이블 키-값 쌍
        spec:                               # Pod의 실제 동작 방식과 구성 설정
          containers:                       # Pod 안에 포함될 컨테이너의 상세 설정
          - name: container                 # 컨테이너 이름
            image: nginx:latest             # 컨테이너 이미지
            ports:                          # 컨테이너 포트 상세 설정
            - containerPort: 80             # 컨테이너의 포트 번호
              protocol: TCP                 # 컨테이너 프로토콜 방식 설정
          tolerations:                      # Pod가 노드의 Taint를 무시하고 스케줄링 될 수 있도록 허용하는 설정
          - key: "node-role.kubernetes.io/control-plane"  # Taint의 키 값
            operator: "Equal"               # Key와 Value를 비교하는 방식을 지정(Operator의 기본 값은 Equal)
            effect: "NoSchedule"            # Taint의 효과를 지정
    ```
    
    - Taint가 걸린 노드에도 배포가 가능하다.
