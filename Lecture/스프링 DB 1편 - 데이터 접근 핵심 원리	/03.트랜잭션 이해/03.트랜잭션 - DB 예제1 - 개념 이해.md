# 트랜잭션

데이터베이스에서 데이터를 등록하거나 수정, 삭제하는 작업을 하나의 논리적인 단위로 묶은 것이 트랜잭션이다. 이 트랜잭션이 완료되어 데이터베이스에 실제로 반영되려면 `commit` 명령어를 사용해야 한다. 반면, 작업 도중 문제가 발생했거나 변경을 취소하고 싶다면 `rollback` 명령어를 사용하여 이전 상태로 되돌릴 수 있다.

중요한 점은 `커밋 전까지는 모든 변경 내용이 임시로 저장된 상태`라는 것이다. 이 상태에서의 변경 내용은 트랜잭션을 시작한 세션(사용자) 에게만 보이며, 다른 세션에서는 전혀 볼 수 없다.

## 1. 기본 상태

![image](https://github.com/user-attachments/assets/e2d169e9-3d88-4092-8f59-f9b6cf6533ec)


세션1과 세션2가 동일한 테이블을 조회하면, 당연히 같은 데이터가 보인다. 아무도 아직 변경 작업을 수행하지 않았기 때문이다.

## 2. 세션1에서 신규 데이터 추가 (커밋 전)

이제 세션1이 트랜잭션을 시작한 뒤 신규 회원1, 회원2를 추가했다고 가정한다. 하지만 아직 커밋하지 않은 상태다. 이 경우 두 가지 상황이 발생한다

- 세션1에서는 select 쿼리를 통해 자신이 추가한 회원1, 회원2를 정상적으로 확인할 수 있다.
- 하지만 세션2에서는 여전히 아무런 변경도 확인할 수 없다. 커밋이 이루어지지 않았기 때문이다.

![image](https://github.com/user-attachments/assets/31e83e33-1540-496a-93fb-6014e0a1f320)


이 말은 즉, 커밋하지 않은 변경 내용은 자신에게만 보이고, 다른 세션에게는 철저히 숨겨진다는 것이다.

## 왜 커밋 전 데이터가 숨겨져야 할까?

만약 커밋하지 않은 데이터가 다른 세션에서도 보이게 된다면 문제가 생긴다. 

예를 들어 세션2가 회원1, 회원2가 있다고 가정하고 어떤 로직을 실행한다고 하자. 하지만 세션1이 그 변경 내용을 `rollback` 한다면, 회원1과 회원2는 실제로 존재하지 않게 된다. 세션2는 잘못된 전제 위에서 잘못된 처리를 하게 되고, 이는 곧 데이터 `정합성의 훼손`으로 이어진다.

그래서 트랜잭션의 기본 원칙 중 하나가 격리성(Isolation) 이다. 이는 바로 이런 상황을 방지하기 위한 것이다. 커밋 전 데이터는 반드시 다른 세션에서 보이면 안 된다.

# commit vs rollback

## 커밋(commit)

- 세션1이 회원 데이터를 추가한 후 커밋을 호출하면, 그때서야 비로소 변경 내용이 모든 사용자에게 반영된다.
- 이제 세션2가 회원 테이블을 조회해도, 회원1과 회원2가 조회된다. 변경 사항이 임시 상태에서 확정 상태로 전환된 것이다.

## 롤백(rollback)

- 세션1이 했던 모든 변경 내용은 원래 상태로 완전히 복구된다.
- 추가했던 회원1, 회원2는 사라지고, 수정이나 삭제했던 내용들도 모두 트랜잭션 이전 상태로 되돌아간다.
