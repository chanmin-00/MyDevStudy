두 세션이 동시에 같은 데이터를 수정하려고 하면 문제가 발생할 수 있다. 예를 들어

- 세션1은 `memberA`의 잔액을 500원으로 수정
- 세션2는 같은 `memberA`의 잔액을 1000원으로 수정

만약 두 세션이 동시에 수정하고, 하나는 롤백하고 하나는 커밋한다면 데이터는 일관되지 않은 상태가 된다. 즉, 트랜잭션의 원자성이 깨지고, 정합성 오류가 발생한다.

# 락(Lock)

데이터베이스는 이런 문제를 막기 위해 트랜잭션이 데이터를 수정할 때 해당 로우(Row)에 락을 건다. 락이 설정된 동안에는 다른 트랜잭션이 그 데이터를 수정할 수 없다. 락은 트랜잭션 종료(커밋/롤백) 시 해제된다.

## 세션1: 트랜잭션 시작 및 update 실행

```sql
set autocommit false;
update member set money = 500 where member_id = 'memberA';
```

- 세션1이 먼저 트랜잭션을 시작하고 memberA의 money 값을 500으로 변경한다.
- 이 순간, 해당 row에 락이 설정된다. (Row-level lock)
- 아직 커밋 전이므로 다른 세션은 이 데이터를 수정할 수 없다.

## 세션2: 트랜잭션 시작 및 update 시도

```sql
set autocommit false;
update member set money = 1000 where member_id = 'memberA';
```

- 세션2도 같은 데이터를 수정하려고 시도한다.
- 하지만 락이 걸려 있어 세션1이 커밋하거나 롤백할 때까지 대기한다.
- 만약 설정된 락 대기 시간을 넘기면, 에러(`lock timeout`)가 발생할 수 있다.

## 세션1: 커밋

```sql
commit;
```

- 커밋으로 트랜잭션이 종료되고, 락이 해제된다.

## 세션2: 락 획득 및 update 진행

- 세션2가 대기하던 락을 획득하고 update를 수행한다.
- 이후 커밋하면 변경 내용이 반영된다.

```sql
commit;
```
