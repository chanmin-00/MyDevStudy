# 백엔드 서버에 환경변수 등록해 사용하기

### 1. Dockerfile 설정

```docker
FROM openjdk:17-jdk

COPY build/libs/*SNAPSHOT.jar app.jar

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

도커파일을 실행하기 전에는 반드시 **빌드를 먼저 진행**해야 한다. 이는 도커 이미지가 .jar 파일을 기반으로 만들어지기 때문이다.

### 2. 환경변수 확인용 코드

```java
@RestController
@RequestMapping("/api/chat/example")
public class ExampleController {

	@Value("${MY_ACCOUNT:default}")
	private String myAccount;
	
	@Value("${MY_PASSWORD:default}")
	private String myPassword;

	// 환경변수 확인 (DataResponse로 반환)
	@GetMapping("/")
	public ResponseEntity<DataResponse<String>> getEnvironmentInfo() {
		String message = "myAccount: " + myAccount + ", myPassword: " + myPassword;
		return ResponseEntity.ok(DataResponse.from(message));
	}
```

@Value 어노테이션을 이용해 환경변수를 주입하고, 설정된 값이 잘 들어왔는지 API를 통해 확인할 수 있도록 구성한다.

### 3. Gradle 빌드

```bash
./gradlew :chat-server:build
```

필요한 모듈을 빌드한 뒤, 도커 이미지를 생성한다.

### 4. 도커 이미지 빌드 및 푸시

```bash
docker buildx build --platform linux/amd64 -t docker.io/jeongchanmin/chat-server:latest --load .
docker push docker.io/jeongchanmin/chat-server:latest
```

도커파일을 기반으로 이미지를 빌드하고, Docker Hub에 푸시하여 배포 가능한 상태로 만든다.

### 5. **Kubernetes 매니페스트 작성**

Deployment 매니페스트를 작성하여 컨테이너 실행 시 환경변수를 함께 등록한다.

```yaml
apiVersion: apps/v1
kind: Deployment

metadata:
  name: chat-deployment

spec:
  replicas: 5
  selector:
    matchLabels:
      app: chat-app

  template:
    metadata:
      labels:
        app: chat-app
    spec:
      containers:
        - name: chat-container
          image: docker.io/jeongchanmin/spring-server:0.1.3
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: MY_ACCOUNT
              value: chanmin
            - name: MY_PASSWORD
              value: pwd1234
```

이때 env 필드를 통해 컨테이너 실행 시 환경변수를 주입한다.

### 6. 매니페스트 적용 및 확인

```bash
kubectl apply -f chat-deployment.yaml
kubectl apply -f chat-service.yaml
```

매니페스트를 적용한 후, 파드가 정상적으로 생성되었는지 확인한다.

```bash
kubectl get pods
```

정상적으로 파드가 실행 중이면, 스프링 서버에 접속하여 등록한 환경변수가 정상적으로 반환되는 것을 확인할 수 있다.

<img width="456" height="327" alt="image" src="https://github.com/user-attachments/assets/ae0f1f3e-b761-4655-a686-83420e424797" />

### 7. 파드 내부에서 직접 환경변수 확인

입력했던 환경변수가 제대로 적용이 되어서 반환되는 것을 확인할 수 있음

이번에는 파드 내부로 접속해서 확인을 해보자/

```java
kubectl exec -it [파드이름] -- bash
kubectl exec -it chat-deployment-66b778776b-wz52q -- bash
```

파드 내부는 리눅스 환경이므로, 다음 명령어를 통해 환경변수를 직접 확인할 수 있다.

```bash
env
```

출력 결과에 MY_ACCOUNT, MY_PASSWORD가 표시되면 환경변수가 올바르게 등록된 것이다.

<img width="322" height="95" alt="image" src="https://github.com/user-attachments/assets/49d36300-1d85-4a99-a061-6ece48f1d359" />

# 컨피그맵(ConfigMap)을 활용해 환경변수 분리하기

## 컨피그맵(ConfigMap)이란?

Spring Boot에서는 환경설정을 application.yml로 분리하고, Next.js에서는 .env 파일로 환경 변수를 관리한다. 

이처럼 **설정값을 코드와 분리하면 유지보수가 쉬워지고**, 개발, 테스트, 프로덕션 환경별 설정을 유연하게 적용할 수 있다. 

쿠버네티스에서도 같은 개념으로 **환경 변수를 전담 관리하는 리소스**가 있는데, 그것이 바로 ConfigMap(컨피그맵)이다.

## 디플로이먼트에 환경변수의 정보를 같이 작성했을 때의 단점

```yaml
apiVersion: apps/v1
kind: Deployment

metadata:
  name: chat-deployment

spec:
  replicas: 5
  selector:
    matchLabels:
      app: chat-app

  template:
    metadata:
      labels:
        app: chat-app
    spec:
      containers:
        - name: chat-container
          image: docker.io/jeongchanmin/chat-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: MY_ACCOUNT
              value: chanmin
            - name: MY_PASSWORD
              value: pwd1234
```

위처럼 Deployment 안에 직접 환경변수를 정의하면 다음과 같은 문제가 발생한다.

- 환경별(개발/운영 등)로 값을 바꾸기 어렵다.
- 환경변수 변경 시마다 매번 Deployment를 수정해야 한다.
- 설정값이 코드와 섞여 관리되어 유지보수가 어렵다.

이러한 문제를 해결하기 위해, 환경 변수 부분을 **ConfigMap으로 분리**한다.

## 컨피그맵 활용하여 환경변수 분리하기

```yaml
apiVersion: v1
kind: ConfigMap

metadata:
	name: chat-config
```

ConfigMap은 apiVersion: v1을 사용하며, key-value 형식으로 데이터를 저장한다.

```yaml
data:
	my-account: chanmin
	my-password: pwd12345
```

여기서 data는 환경변수처럼 사용할 설정값들을 정의하는 부분이다. 이 ConfigMap은 chat-config라는 이름으로 쿠버네티스에 등록된다

**최종 yaml**

```yaml
apiVersion: v1
kind: ConfigMap

metadata:
  name: chat-config

data:
  my-account: chanmin
  my-password: pwd12345
```

### **Deployment에서 ConfigMap 참조하기**

이제 Deployment 파일에서 직접 값을 적는 대신, ConfigMap의 키를 참조하도록 변경한다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chat-deployment
spec:
  replicas: 5
  selector:
    matchLabels:
      app: chat-app
  template:
    metadata:
      labels:
        app: chat-app
    spec:
      containers:
        - name: chat-container
          image: docker.io/jeongchanmin/chat-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: MY_ACCOUNT
              valueFrom:
                configMapKeyRef:
                  name: chat-config
                  key: my-account
            - name: MY_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: chat-config
                  key: my-password
```

이 구조에서 name은 컨테이너 내부에서 사용할 환경변수 이름이고, valueFrom → configMapKeyRef는 ConfigMap으로부터 값을 가져오겠다는 의미이다.

즉, chat-config 리소스의 my-account와 my-password 키를 참조하게 된다.

### **ConfigMap 반영 및 확인**

1. **ConfigMap 생성**

```bash
kubectl apply -f chat-config.yaml
```

<img width="591" height="58" alt="image" src="https://github.com/user-attachments/assets/1eb8607a-bf85-4b66-a829-54c957bf89dc" />

1. **ConfigMap 확인**

```bash
kubectl get configmap
```

chat-config 리소스가 정상적으로 생성된 것을 확인할 수 있다

<img width="524" height="92" alt="image" src="https://github.com/user-attachments/assets/6b4a7dc2-1165-41ad-8801-dae02b1e62a4" />

1. **Deployment 적용**

ConfigMap 참조 설정을 포함한 Deployment 파일을 다시 반영한다.

```bash
kubectl apply -f chat-deployment.yaml
```

1. **Deployment 재시작 (환경변수 갱신 반영)**

```bash
kubectl rollout restart deployment chat-deployment
```

30000번 포트로 접속하여 확인해보면, ConfigMap에서 불러온 환경변수 값이 애플리케이션에 정상 반영된 것을 볼 수 있다.

<img width="488" height="271" alt="image" src="https://github.com/user-attachments/assets/c7d34816-5119-49f9-b02b-9dc374e8ada9" />

컨피그맵(ConfigMap)은 **환경별 설정값을 외부 파일처럼 분리하여 관리**할 수 있게 해주는 쿠버네티스 리소스이다.

이를 통해 다음과 같은 장점을 얻을 수 있다

- 환경(Dev, Test, Prod) 별 설정 변경이 용이
- 애플리케이션 코드와 설정 분리로 유지보수성 향상
- 동일한 Deployment 파일을 다양한 환경에서 재사용 가능

즉, 컨피그맵은 쿠버네티스에서 환경변수를 체계적으로 관리하기 위한 핵심 도구이다.

# 시크릿(Secret)을 활용해 민감한 값을 환경변수로 분리하기

## 시크릿이란?

시크릿은 컨피그맵과 비슷하게 환경 변수를 외부 파일로 분리해 관리하는 오브젝트이다. 하지만 비밀번호, API 키, 인증 토큰 등과 같은 보안적으로 중요한 정보를 관리하기 위한 용도라는 점에서 차이가 있다.

즉, 시크릿은 민감한 값을 안전하게 저장하고 애플리케이션에 주입하기 위해 사용된다.

## 시크릿을 활용해 민감한 값을 따로 분리하기

아래와 같이 chat-secret.yaml 파일을 추가한다.

```yaml
apiVersion: v1
kind: Secret

metadata:
	name: chat-secret
	
stringData:
	my-password: my-secret-password
```

- metadata.name: 시크릿 이름을 지정한다.
- stringData: 문자열 형태로 민감한 값을 입력하면 쿠버네티스가 내부적으로 Base64로 인코딩해 저장한다.

이제 디플로이먼트 매니페스트 파일에서 시크릿 값을 참조하도록 수정한다.

```yaml
valueFrom:
	secretKeyRef:
		name: chat-secret
		key: my-password
```

my-password라는 키 값에서 해당 value를 가져오겠다는 의미이다. 시크릿과 컨피그맵의 형식은 거의 비슷하지만, **보안 수준이 다르다**는 점만 기억하면 된다.

**최종 디플로이먼트 매니페스트 파일**

```yaml
apiVersion: apps/v1
kind: Deployment

metadata:
  name: chat-deployment

spec:
  replicas: 5
  selector:
    matchLabels:
      app: chat-app

  template:
    metadata:
      labels:
        app: chat-app
    spec:
      containers:
        - name: chat-container
          image: docker.io/jeongchanmin/chat-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: MY_ACCOUNT
              valueFrom:
                configMapKeyRef:
                  name: chat-config
                  key: my-account
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: chat-secret
                  key: my-password
```

### 적용 및 확인

시크릿 파일을 생성하고, 정상적으로 반영되는지 확인한다.

```yaml
kubectl apply -f chat-secret.yaml
```

<img width="479" height="47" alt="image" src="https://github.com/user-attachments/assets/f05297e2-bb59-4838-9b4d-bce350a35b91" />

시크릿이 생성되었는지 확인한다.

```yaml
kubectl get secret
```

<img width="491" height="91" alt="image" src="https://github.com/user-attachments/assets/73d8205d-2d2d-4c2d-95d0-d70a24c533d0" />

컨피그맵에서 비밀번호 관련 내용을 제거했으므로 수정 사항을 반영한다.

```yaml
kubectl apply -f chat-config.yaml
```

디플로이먼트 파일도 변경되었기 때문에 다시 적용한다.

```yaml
kubectl apply -f chat-deployment.yaml
```

그리고 디플로이먼트를 재시작한다.

```yaml
kubectl rollout restart deployment chat-deployment
```

<img width="646" height="368" alt="image" src="https://github.com/user-attachments/assets/d2972e41-f1f5-4c4c-a0ab-4badd3e098fb" />

정상적으로 반영되었다면, 새로운 시크릿 값이 컨테이너 환경 변수로 전달되어 데이터가 변경된 것을 확인할 수 있다.
